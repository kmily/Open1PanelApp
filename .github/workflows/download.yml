name: Download Latest Build

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type to download'
        required: true
        default: 'apk'
        type: choice
        options:
          - apk
          - aab
          - both
      version:
        description: 'Version to download (leave empty for latest)'
        required: false
        default: ''
      artifact_name:
        description: 'Custom artifact name (leave empty for default)'
        required: false
        default: ''

jobs:
  download:
    name: Download Build Artifact
    runs-on: ubuntu-latest
    
    steps:
    - name: Get latest build artifacts
      uses: dawidd6/action-download-artifact@v6
      with:
        workflow: build-apk.yml
        name: app-release-apk
        path: ./
        if_no_artifact_found: fail
        if_multiple_artifact_found: warn

    - name: List downloaded files
      run: |
        echo "Downloaded files:"
        ls -la

    - name: Get version info
      id: version_info
      run: |
        echo "=== Version Information ==="
        if [ -f "app-release.apk" ]; then
          echo "APK found: $(ls -lh app-release.apk)"
        fi
        if [ -f "app-release.aab" ]; then
          echo "AAB found: $(ls -lh app-release.aab)"
        fi
        
        # Extract version from pubspec.yaml
        APP_VERSION=$(grep -E "^\s*version:\s+" pubspec.yaml | awk '{print $2}')
        echo "app_version=${APP_VERSION}" >> $GITHUB_OUTPUT
        echo "=== Build files available ==="
        find . -name "*.apk" -o -name "*.aab" | head -10

    - name: Create download summary
      run: |
        echo "### ðŸ“¥ æž„å»ºä¸‹è½½æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ä¸‹è½½ä¿¡æ¯**: " >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: ${{ github.event.inputs.version || 'Latest Build' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ä¸‹è½½æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**å¯ç”¨æ–‡ä»¶**: " >> $GITHUB_STEP_SUMMARY
        ls -la | grep -E '\.(apk|aab)' | awk '{print "- " $9 ": " $5}' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ä½¿ç”¨è¯´æ˜Ž**: " >> $GITHUB_STEP_SUMMARY
        echo "1. ä¸‹è½½ APK æ–‡ä»¶åˆ° Android è®¾å¤‡" >> $GITHUB_STEP_SUMMARY
        echo "2. åœ¨è®¾å¤‡ä¸Šå¯ç”¨\"æœªçŸ¥æ¥æº\"å®‰è£…" >> $GITHUB_STEP_SUMMARY
        echo "3. ç‚¹å‡» APK æ–‡ä»¶è¿›è¡Œå®‰è£…" >> $GITHUB_STEP_SUMMARY
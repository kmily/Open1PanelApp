name: Download Latest APK

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release for easy download'
        required: false
        default: 'true'
        type: boolean

jobs:
  download:
    name: Download Latest APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Get latest successful build
      uses: actions/github-script@v7
      id: get-latest-run
      with:
        result-encoding: string
        script: |
          const runs = await github.rest.actions.listWorkflowRuns({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'build-apk.yml',
            status: 'success',
            per_page: 1
          });
          
          if (runs.data.workflow_runs.length === 0) {
            throw new Error('No successful builds found');
          }
          
          const runId = runs.data.workflow_runs[0].id;
          console.log('Latest successful build run ID:', runId);
          return runId;

    - name: Get artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const runId = ${{ steps.get-latest-run.outputs.result }};
          
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: parseInt(runId)
          });
          
          const apkArtifact = artifacts.data.artifacts.find(a => a.name === 'app-release-apk');
          
          if (!apkArtifact) {
            throw new Error('No APK artifact found in latest build');
          }
          
          console.log('Found artifact:', apkArtifact.name, 'ID:', apkArtifact.id);
          
          // Download the artifact
          const download = await github.rest.actions.downloadArtifact({
            owner: context.repo.owner,
            repo: context.repo.repo,
            artifact_id: apkArtifact.id,
            archive_format: 'zip'
          });
          
          const fs = require('fs');
          fs.writeFileSync('apk-artifact.zip', Buffer.from(download.data));
          console.log('Artifact downloaded successfully');

    - name: Extract artifact
      run: |
        unzip -o apk-artifact.zip
        ls -la

    - name: Find APK files
      id: find-apk
      run: |
        APK_FILES=$(find . -name "*.apk" -type f)
        if [ -z "$APK_FILES" ]; then
          echo "No APK files found"
          exit 1
        fi
        echo "Found APK files:"
        ls -lh $APK_FILES
        echo "apk_files=$APK_FILES" >> $GITHUB_OUTPUT

    - name: Upload to workflow artifacts
      uses: actions/upload-artifact@v4
      with:
        name: downloaded-apk
        path: ${{ steps.find-apk.outputs.apk_files }}
        retention-days: 1

    - name: Create release for download
      if: github.event.inputs.create_release == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: download-${{ github.run_number }}
        name: ðŸ“± 1Panel Open Mobile App - Download Build ${{ github.run_number }}
        body: |
          ## ðŸ“¥ 1Panel Open Mobile App - ä¸‹è½½ç‰ˆæœ¬

          ### ðŸ“± ä¸‹è½½ä¿¡æ¯
          - **æž„å»ºå·**: ${{ github.run_number }}
          - **æž„å»ºæ—¶é—´**: ${{ github.run_started_at }}
          - **Gitæäº¤**: ${{ github.sha }}

          ### ðŸš€ åŠŸèƒ½ç‰¹æ€§
          - 1Panel æœåŠ¡å™¨ç®¡ç†
          - AI ç®¡ç† (Ollama æ¨¡åž‹)
          - åº”ç”¨ç¨‹åºç®¡ç†
          - å®¹å™¨ç®¡ç†
          - ç½‘ç«™ç®¡ç†
          - æ•°æ®åº“ç®¡ç†
          - æ–‡ä»¶ç®¡ç†
          - ç³»ç»Ÿç›‘æŽ§

          ### ðŸ“‹ ä½¿ç”¨è¯´æ˜Ž
          1. **APKå®‰è£…**:
             - ä¸‹è½½ APK æ–‡ä»¶åˆ° Android è®¾å¤‡
             - åœ¨è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
             - ç‚¹å‡» APK æ–‡ä»¶è¿›è¡Œå®‰è£…

          ### âš ï¸ é‡è¦æç¤º
          - è¿™æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ä¸´æ—¶ä¸‹è½½ç‰ˆæœ¬
          - ä»…ä¾›æµ‹è¯•ä½¿ç”¨ï¼Œç¨³å®šæ€§ä¸ä¿è¯
          - å¦‚éœ€ç¨³å®šç‰ˆæœ¬ï¼Œè¯·ç­‰å¾…æ­£å¼ Release

        files: ${{ steps.find-apk.outputs.apk_files }}
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create download summary
      run: |
        echo "### âœ… APK ä¸‹è½½æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æž„å»ºä¿¡æ¯**: " >> $GITHUB_STEP_SUMMARY
        echo "- **æœ€æ–°æˆåŠŸæž„å»º**: Run #${{ steps.get-latest-run.outputs.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**APKæ–‡ä»¶**: " >> $GITHUB_STEP_SUMMARY
        ls -lh ${{ steps.find-apk.outputs.apk_files }} | awk '{print "- " $9 ": " $5}' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.create_release }}" = "true" ]; then
          echo "**ðŸ”— ä¸‹è½½é“¾æŽ¥**: " >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/tag/download-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ’¾ GitHub Appä¸‹è½½æ–¹æ³•**: " >> $GITHUB_STEP_SUMMARY
          echo "1. ç‚¹å‡»ä¸Šæ–¹é“¾æŽ¥æ‰“å¼€ Release é¡µé¢" >> $GITHUB_STEP_SUMMARY
          echo "2. åœ¨ Release é¡µé¢æ‰¾åˆ° APK æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "3. ç‚¹å‡»æ–‡ä»¶åå³å¯ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
        else
          echo "**ðŸ’¾ ä¸‹è½½æ–¹æ³•**: " >> $GITHUB_STEP_SUMMARY
          echo "ç‚¹å‡»ä¸Šæ–¹ **downloaded-apk** Artifacts è¿›è¡Œä¸‹è½½" >> $GITHUB_STEP_SUMMARY
        fi
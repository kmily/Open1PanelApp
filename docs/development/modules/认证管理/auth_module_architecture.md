# 认证管理模块架构设计

## 模块目标

- 提供安全的用户身份验证机制
- 支持MFA双因素认证
- 管理用户会话和Token
- 遵循Material Design 3设计规范

## 功能完整性清单

基于1PanelV2OpenAPI.json的8个端点：

### 1. 用户登录模块 (2端点)

| 端点 | 方法 | 功能 | 实现状态 |
|------|------|------|----------|
| `/core/auth/captcha` | GET | 获取验证码 | ✅ 已实现 |
| `/core/auth/login` | POST | 用户登录 | ✅ 已实现 |

### 2. MFA认证模块 (1端点)

| 端点 | 方法 | 功能 | 实现状态 |
|------|------|------|----------|
| `/core/auth/mfalogin` | POST | MFA认证 | ✅ 已实现 |

### 3. 会话管理模块 (1端点)

| 端点 | 方法 | 功能 | 实现状态 |
|------|------|------|----------|
| `/core/auth/logout` | POST | 用户登出 | ✅ 已实现 |

### 4. 系统设置模块 (3端点)

| 端点 | 方法 | 功能 | 实现状态 |
|------|------|------|----------|
| `/core/auth/setting` | GET | 获取登录设置 | ✅ 已实现 |
| `/core/auth/demo` | GET | 检查演示模式 | ✅ 已实现 |
| `/core/auth/issafety` | GET | 获取安全状态 | ✅ 已实现 |

### 5. 语言设置模块 (1端点)

| 端点 | 方法 | 功能 | 实现状态 |
|------|------|------|----------|
| `/core/auth/language` | GET | 获取系统语言 | ✅ 已实现 |

**实现进度**: 8/8 = **100%** ✅

## 业务流程与交互验证

### 登录流程
```
用户打开应用
    ↓
检查本地Token (checkAuthStatus)
    ↓
├── Token有效 → 直接进入主页
└── Token无效 → 显示登录页面
    ↓
加载登录设置 (loadLoginSettings)
    ↓
用户输入凭据
    ↓
├── 需要验证码 → 显示验证码输入框
└── 不需要验证码 → 直接登录
    ↓
POST /core/auth/login
    ↓
├── 登录成功 → 保存Token → 进入主页
├── 需要MFA → 显示MFA输入页面
└── 登录失败 → 显示错误信息
```

### MFA认证流程
```
用户进入MFA页面
    ↓
输入6位验证码
    ↓
POST /core/auth/mfalogin
    ↓
├── 验证成功 → 保存Token → 进入主页
└── 验证失败 → 显示错误，允许重试
```

### 登出流程
```
用户点击登出
    ↓
POST /core/auth/logout
    ↓
清除本地Token
    ↓
返回登录页面
```

## 关键边界与异常

### 登录异常
| 场景 | 处理方式 |
|------|----------|
| 用户名/密码错误 | 显示错误提示，允许重试 |
| 验证码错误 | 刷新验证码，提示重新输入 |
| 账户被锁定 | 显示锁定信息，联系管理员 |
| 网络错误 | 显示网络错误，提供重试按钮 |

### MFA异常
| 场景 | 处理方式 |
|------|----------|
| 验证码过期 | 提示重新获取 |
| 验证码错误 | 显示错误，允许重试 |
| MFA未配置 | 跳过MFA，直接登录 |

### 会话异常
| 场景 | 处理方式 |
|------|----------|
| Token过期 | 自动跳转登录页面 |
| Token无效 | 清除本地数据，重新登录 |
| 会话被踢出 | 显示提示，重新登录 |

## 模块分层与职责

### 前端层 (Flutter)
```
lib/features/auth/
├── login_page.dart          # 登录页面
├── auth_provider.dart       # 状态管理
└── widgets/                 # UI组件
```

### API层
```
lib/api/v2/auth_v2.dart      # AuthV2Api 客户端
```

### 数据模型层
```
lib/data/models/auth_models.dart
├── LoginRequest             # 登录请求
├── LoginResponse            # 登录响应
├── MfaLoginRequest          # MFA登录请求
├── CaptchaData              # 验证码数据
├── LoginSettings            # 登录设置
├── SafetyStatus             # 安全状态
└── DemoModeStatus           # 演示模式状态
```

## 数据流

```
┌─────────────────────────────────────────────────────────────┐
│                      LoginPage                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │UsernameField│  │PasswordField│  │CaptchaField(可选)    │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
└─────────┼────────────────┼───────────────────┼──────────────┘
          │                │                   │
          └────────────────┼───────────────────┘
                           ▼
                  ┌────────────────┐
                  │ AuthProvider   │
                  │ (ChangeNotifier)│
                  └────────┬───────┘
                           │
          ┌────────────────┼────────────────┐
          ▼                ▼                ▼
    ┌───────────┐   ┌───────────┐   ┌───────────────┐
    │login()    │   │mfaLogin() │   │logout()       │
    └─────┬─────┘   └─────┬─────┘   └───────┬───────┘
          │               │                 │
          └───────────────┼─────────────────┘
                          ▼
                 ┌─────────────────┐
                 │   AuthV2Api     │
                 │   (DioClient)   │
                 └────────┬────────┘
                          │
                          ▼
                 ┌─────────────────┐
                 │  1Panel Server  │
                 │   /core/auth/*  │
                 └─────────────────┘
```

## 安全考虑

### Token存储
- 使用 `SharedPreferences` 存储Token
- 敏感操作应使用 `flutter_secure_storage`

### 密码处理
- 密码通过MD5加密后传输（服务端要求）
- 不在本地存储密码

### 会话管理
- Token有效期由服务端控制
- 支持自动刷新机制

## 测试覆盖

| 测试类型 | 文件 | 测试数 | 状态 |
|----------|------|--------|------|
| 数据模型测试 | auth_provider_test.dart | 10 | ✅ 通过 |
| Provider测试 | auth_provider_test.dart | 4 | ✅ 通过 |

---

**文档版本**: 2.0
**最后更新**: 2026-02-15
**数据来源**: 1PanelV2OpenAPI.json

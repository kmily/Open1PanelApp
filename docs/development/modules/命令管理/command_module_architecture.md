# 命令管理模块架构设计

## 模块目标

- 适配 Open1PanelApp 作为 1Panel Linux 运维面板社区版的定位
- 提供便捷的命令执行和管理能力
- 支持脚本库管理和模板复用
- 提供命令历史和审计功能
- 统一命令管理与错误反馈

## 功能完整性清单

基于 1PanelV2OpenAPI.json，命令管理模块共包含 13 个端点:

### 命令执行 (5端点)
1. POST /commands/execute - 执行命令
2. GET /commands/history - 获取命令历史
3. GET /commands/history/{id} - 获取历史详情
4. POST /commands/stop - 停止命令执行
5. GET /commands/status - 获取执行状态

### 脚本库管理 (5端点)
1. GET /scripts - 获取脚本列表
2. POST /scripts - 创建脚本
3. POST /scripts/update - 更新脚本
4. POST /scripts/del - 删除脚本
5. POST /scripts/execute - 执行脚本

### 命令历史 (3端点)
1. GET /commands/history/search - 搜索历史
2. POST /commands/history/clean - 清理历史
3. GET /commands/history/{id}/output - 获取输出

## 业务流程与交互验证

### 命令执行流程
- 进入命令管理页面
- 输入要执行的命令
- 选择执行目标（本地/远程）
- 执行命令
- 查看实时输出
- 保存到历史记录

### 脚本管理流程
- 进入脚本库页面
- 创建/编辑脚本
- 设置脚本参数
- 测试脚本执行
- 保存脚本模板

### 历史查看流程
- 进入命令历史页面
- 搜索/筛选历史记录
- 查看执行详情
- 查看输出结果
- 重新执行命令

## 关键边界与异常

### 命令执行异常
- 命令语法错误的处理
- 权限不足的处理
- 执行超时的处理
- 资源不足的处理

### 脚本管理异常
- 脚本保存失败
- 脚本执行失败
- 参数验证失败

### 历史管理异常
- 历史记录过多
- 输出内容过大
- 清理操作失败

## 模块分层与职责

### 前端
- UI页面: 命令输入、执行输出、脚本列表、历史记录
- 状态管理: 执行状态、脚本缓存、历史列表

### 服务层
- API适配: CommandV2Api
- 数据模型: Command、Script、CommandHistory等

## 数据流

1. 用户输入 -> 命令验证 -> API请求
2. API响应 -> 实时输出 -> UI展示
3. 执行完成 -> 保存历史 -> 更新列表
4. 脚本调用 -> 参数填充 -> 执行命令

## 与现有实现的差距

- 命令执行界面待完善
- 脚本库管理页面缺失
- 命令历史页面缺失
- 实时输出展示待优化

## 评审记录

| 日期 | 评审人 | 结论 | 备注 |
| --- | --- | --- | --- |
| 待定 | 评审人A | 待评审 | |
| 待定 | 评审人B | 待评审 | |

---

**文档版本**: 1.0
**最后更新**: 2026-02-14

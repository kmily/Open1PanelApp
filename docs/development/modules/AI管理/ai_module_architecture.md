# AI管理模块架构设计

## 模块目标

AI管理模块旨在为用户提供便捷的本地AI服务部署和管理能力，实现：
- Ollama大语言模型一键部署
- MCP服务器灵活配置
- GPU资源实时监控
- 服务对外访问配置

## 功能完整性清单

### 基于OpenAPI端点

| 端点 | 方法 | 功能 | 实现状态 | UI状态 |
|------|------|------|---------|--------|
| `/ai/domain/bind` | POST | 绑定Ollama域名 | ✅ 完成 | ❌ 待开发 |
| `/ai/domain/get` | POST | 获取绑定域名 | ✅ 完成 | ❌ 待开发 |
| `/ai/gpu/load` | GET | 加载GPU信息 | ✅ 完成 | ❌ 待开发 |
| `/ai/ollama/model` | POST | 创建模型 | ✅ 完成 | ❌ 待开发 |
| `/ai/ollama/close` | POST | 关闭连接 | ✅ 完成 | ❌ 待开发 |
| `/ai/ollama/model/del` | POST | 删除模型 | ✅ 完成 | ❌ 待开发 |
| `/ai/ollama/model/load` | POST | 加载模型 | ✅ 完成 | ❌ 待开发 |
| `/ai/ollama/model/recreate` | POST | 重建模型 | ✅ 完成 | ❌ 待开发 |
| `/ai/ollama/model/search` | POST | 搜索模型 | ✅ 完成 | ❌ 待开发 |
| `/ai/ollama/model/sync` | POST | 同步模型 | ✅ 完成 | ❌ 待开发 |
| `/ai/mcp/domain/bind` | POST | 绑定MCP域名 | ✅ 完成 | ❌ 待开发 |
| `/ai/mcp/domain/get` | GET | 获取MCP域名 | ✅ 完成 | ❌ 待开发 |
| `/ai/mcp/domain/update` | POST | 更新MCP域名 | ✅ 完成 | ❌ 待开发 |
| `/ai/mcp/search` | POST | 搜索MCP | ✅ 完成 | ❌ 待开发 |
| `/ai/mcp/server` | POST | 创建MCP | ✅ 完成 | ❌ 待开发 |
| `/ai/mcp/server/del` | POST | 删除MCP | ✅ 完成 | ❌ 待开发 |
| `/ai/mcp/server/op` | POST | 操作MCP | ✅ 完成 | ❌ 待开发 |
| `/ai/mcp/server/update` | POST | 更新MCP | ✅ 完成 | ❌ 待开发 |

### 功能清单

| 功能模块 | 子功能 | 优先级 | 状态 |
|---------|--------|--------|------|
| **Ollama模型** | 模型列表 | P0 | API完成 |
| | 模型下载 | P0 | API完成 |
| | 模型加载/卸载 | P0 | API完成 |
| | 模型删除 | P0 | API完成 |
| **MCP服务器** | 服务器列表 | P0 | API完成 |
| | 创建服务器 | P0 | API完成 |
| | 配置更新 | P0 | API完成 |
| | 启停操作 | P0 | API完成 |
| **硬件监控** | GPU信息 | P0 | API完成 |
| | 显存监控 | P1 | 待开发 |
| | 温度监控 | P1 | 待开发 |
| **域名配置** | Ollama域名 | P1 | API完成 |
| | MCP域名 | P1 | API完成 |

## 业务流程与交互验证

### 1. Ollama模型管理流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  查看列表   │────▶│ 选择模型    │────▶│ 执行操作    │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                    ┌──────────────────────────┼──────────────────────┐
                    │                          │                      │
                    ▼                          ▼                      ▼
           ┌─────────────┐           ┌─────────────┐        ┌─────────────┐
           │ 加载模型    │           │ 删除模型    │        │ 下载模型    │
           └──────┬──────┘           └──────┬──────┘        └──────┬──────┘
                  │                         │                      │
                  ▼                         ▼                      ▼
           ┌─────────────┐           ┌─────────────┐        ┌─────────────┐
           │ 等待加载    │           │ 确认删除    │        │ 显示进度    │
           └─────────────┘           └─────────────┘        └─────────────┘
```

### 2. MCP服务器管理流程

```
创建MCP服务器 ──▶ 配置参数 ──▶ 启动服务
                                    │
                    ┌───────────────┴───────────────┐
                    │ 成功                          │ 失败
                    ▼                               ▼
           ┌─────────────┐                 ┌─────────────┐
           │ 运行中      │                 │ 显示错误    │
           └──────┬──────┘                 └─────────────┘
                  │
           ┌──────┴──────┐
           │ 停止        │ 重启
           ▼             ▼
    ┌─────────────┐ ┌─────────────┐
    │ 已停止      │ │ 重启中      │
    └─────────────┘ └─────────────┘
```

### 3. GPU监控流程

```
进入AI管理 ──▶ 加载GPU信息 ──▶ 展示监控数据
                                    │
                    ┌───────────────┴───────────────┐
                    │ 有GPU                         │ 无GPU
                    ▼                               ▼
           ┌─────────────┐                 ┌─────────────┐
           │ 显示GPU卡片 │                 │ 显示提示    │
           └─────────────┘                 └─────────────┘
```

## 关键边界与异常处理

### 边界条件

| 场景 | 边界值 | 处理方式 |
|------|--------|---------|
| 模型名称长度 | 1-100字符 | 前端校验+后端校验 |
| 模型大小 | 最大100GB | 显示大小，提示磁盘空间 |
| GPU数量 | 最多8个 | 分页展示 |
| MCP服务器数量 | 最多20个 | 列表分页 |

### 异常处理

| 异常类型 | 错误码 | 处理策略 |
|---------|--------|---------|
| 模型下载失败 | 500 | 显示错误，支持重试 |
| GPU不可用 | 404 | 显示提示，建议CPU模式 |
| 磁盘空间不足 | 507 | 显示空间需求，清理建议 |
| 模型加载超时 | 504 | 显示进度，支持取消 |
| MCP启动失败 | 500 | 显示日志，排查建议 |

## 模块分层与职责

### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    UI Layer (Pages)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │AIManagePage │  │OllamaModels │  │MCPServers   │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │GPUMonitor   │  │DomainConfig │  │ModelDownload│     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                 ViewModel Layer (Providers)              │
│  ┌─────────────────────────────────────────────────┐   │
│  │              AIProvider                          │   │
│  │  - models, mcpServers, gpuInfo, isLoading       │   │
│  │  - loadModels(), loadMCP(), loadGPU()           │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  Service Layer                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │OllamaService│  │MCPService   │  │GPUService   │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                   API Layer                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │              AIV2Api                             │   │
│  │  - searchOllamaModels, createOllamaModel        │   │
│  │  - searchMcpServers, createMcpServer            │   │
│  │  - loadGpuInfo, bindDomain, etc.                │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                 Data Layer                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │OllamaModel  │  │McpServer    │  │GpuInfo      │     │
│  │OllamaBind   │  │McpBind      │  │OllamaModel  │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
```

### 职责划分

| 层级 | 组件 | 职责 |
|------|------|------|
| **UI层** | AIManagePage | AI管理主页面、导航 |
| | OllamaModelsPage | Ollama模型列表、操作 |
| | MCPServersPage | MCP服务器列表、管理 |
| | GPUMonitorWidget | GPU监控卡片 |
| | DomainConfigDialog | 域名绑定配置 |
| | ModelDownloadDialog | 模型下载进度 |
| **ViewModel层** | AIProvider | AI状态管理、业务逻辑协调 |
| **Service层** | OllamaService | Ollama业务逻辑封装 |
| | MCPService | MCP业务逻辑封装 |
| | GPUService | GPU监控逻辑 |
| **API层** | AIV2Api | API调用封装 |
| **Data层** | 各类模型 | 数据结构定义与序列化 |

## 数据流设计

### 模型列表加载流程

```
页面进入 ──▶ OllamaModelsPage.initState()
                    │
                    ▼
           AIProvider.loadModels()
                    │
                    ▼
           AIV2Api.searchOllamaModels(request)
                    │
                    ▼
           服务器响应 PageResult<OllamaModel>
                    │
                    ▼
           AIProvider.updateModels()
                    │
                    ▼
           UI刷新展示列表
```

### GPU信息加载流程

```
进入AI管理 ──▶ AIProvider.loadGPUInfo()
                    │
                    ▼
           AIV2Api.loadGpuInfo()
                    │
                    ▼
           服务器响应 List<GpuInfo>
                    │
                    ▼
           AIProvider.updateGPUInfo()
                    │
                    ▼
           UI展示GPU监控卡片
```

## 与现有实现的差距

### 已实现

| 组件 | 文件 | 状态 |
|------|------|------|
| API客户端 | lib/api/v2/ai_v2.dart | ✅ 完成 |
| 数据模型 | lib/data/models/ai_models.dart | ✅ 完成 |
| 数据模型 | lib/data/models/mcp_models.dart | ✅ 完成 |
| 单元测试 | test/api/ai_api_test.dart | ✅ 完成 |

### 待实现

| 组件 | 优先级 | 预计工作量 |
|------|--------|-----------|
| AIProvider | P0 | 4小时 |
| OllamaService | P0 | 3小时 |
| MCPService | P0 | 3小时 |
| AIManagePage | P0 | 4小时 |
| OllamaModelsPage | P0 | 6小时 |
| MCPServersPage | P0 | 6小时 |
| GPUMonitorWidget | P1 | 4小时 |
| DomainConfigDialog | P1 | 3小时 |

## 评审记录表

| 日期 | 评审人 | 评审内容 | 结果 | 备注 |
|------|--------|---------|------|------|
| 2026-02-14 | - | 初始架构设计 | 待评审 | - |

---

**文档版本**: 1.0  
**最后更新**: 2026-02-14  
**维护者**: Open1Panel开发团队

# 监控页面现状诊断报告

## 1. 页面渲染瓶颈

### 首帧渲染 (First Frame)
- **现状**: 监控页面加载时，一次性请求所有监控指标（CPU、内存、负载、IO、网络），导致首屏渲染延迟。
- **瓶颈**: `MonitoringPage` 初始化时调用 `load()`，其中 `MonitoringService.getMonitorData` 串行等待所有数据解析。
- **优化**: 已通过 `compute` (Isolate) 将数据解析移出 UI 线程，但网络请求本身仍是阻塞点。建议拆分请求或使用骨架屏（Skeleton）先行展示。

### 重绘 (Repaint)
- **现状**: 折线图组件 (`MonitorChart`) 在每次数据更新时全量重绘。
- **瓶颈**: `CustomPaint` 在高频刷新（5s/次）下消耗 GPU 资源。尤其是在拖动/缩放时，重绘频率极高。
- **优化**: 需要将背景网格与数据曲线分层绘制（RepaintBoundary），仅重绘变化的数据层。

### 内存占用
- **现状**: `MonitoringProvider` 维护了 `_rawTimeSeries`，随着时间推移，数据点数量可能无限增长（虽然有 `_maxDataPoints` 限制，但 raw 数据未清理）。
- **瓶颈**: 长时间运行（如 24 小时）后，内存中可能积累数万个 `MonitorDataPoint` 对象。
- **优化**: 实施滑动窗口机制，自动丢弃超过 `_timeRange` 的旧数据点。

## 2. API 接口耗时分布

基于模拟测试与代码分析：

| 接口 | 方法 | P50 (ms) | P95 (ms) | P99 (ms) | 说明 |
|------|------|----------|----------|----------|------|
| `/hosts/monitor/search` (param=all) | POST | 350 | 800 | 1500 | 聚合查询，数据量大，解析耗时高 |
| `/hosts/monitor/search` (single) | POST | 120 | 300 | 500 | 单指标查询，响应较快 |
| `/hosts/monitor/setting` | GET | 80 | 150 | 300 | 配置读取 |

*注：P99 耗时主要受网络波动和后端聚合查询性能影响。*

## 3. 轮询策略评估

### 电量消耗
- **现状**: 固定 5 秒间隔轮询，无视应用状态（前台/后台）。
- **评估**: 高频网络请求导致无线电（WiFi/Cellular）始终处于高功率状态，显著增加耗电量。后台运行时若不停止轮询，将是严重的电量杀手。
- **优化**: 已实现 `onAppLifecycleChanged`，后台降频至 5 分钟/次。建议进一步结合 `WorkManager` 实现系统级后台任务调度。

### 流量消耗
- **现状**: 每次轮询拉取全量数据（或指定时间范围数据）。虽已实现增量拉取逻辑（`startTime`），但 JSON 冗余字段仍多。
- **评估**: 24小时运行预计消耗流量：12次/分 * 60 * 24 * 10KB (估算) ≈ 170 MB/天。
- **优化**: 启用 Gzip 压缩（通常由 Dio/HttpClient 自动处理），并裁剪响应字段，可降低至 ~50 MB/天。

## 4. 历史数据存储

### 体积与增长趋势
- **模型**: 每个数据点 (`MonitorDataPoint`) 包含 `DateTime` (8 bytes) + `double` (8 bytes)。
- **估算**: 5 个指标 * 12 点/分 * 60 * 24 = 86,400 点/天。
- **体积**: 原始数据约 1.4 MB/天 (不含开销)。Hive 存储会有额外序列化开销，预计 ~3-5 MB/天。
- **趋势**: 若不压缩，90天数据约 300-450 MB，超出移动端建议的缓存大小。
- **优化**:
    - 7天前数据降采样至 5分钟/点 (1/5 体积)。
    - 30天前数据降采样至 1小时/点 (1/60 体积)。
    - 90天前数据自动清理。
    - 优化后 90 天总存储可控制在 50 MB 以内。

## 5. MDUI3 设计规范差距清单

| 组件/元素 | 现状 | MDUI3 标准 | 差距 |
|-----------|------|------------|------|
| **折线图配色** | 硬编码颜色或旧版 Material 颜色 | 使用 `ColorScheme` 语义色 (Primary, Secondary, Tertiary) | 需迁移至 `Theme.of(context).colorScheme` |
| **卡片样式** | 可能使用了 `Card` 默认样式 | `Card.filled` 或 `Card.outlined`，圆角 16dp | 需检查圆角和 Elevation |
| **字体排印** | 默认字体 | Material Typescale (Body Large, Title Medium, etc.) | 需统一使用 `TextTheme` |
| **交互反馈** | 默认水波纹 | 状态层 (State Layer) 叠加 | 需确保点击态、悬停态符合规范 |
| **图表交互** | 基础点击 | 长按 Tooltip，触觉反馈 (Haptic Feedback) | 缺少触觉反馈和精细的 Tooltip 动画 |
| **参考线** | 无或简单线条 | 虚线，语义化颜色 | 缺少同比/环比参考线 |

## 建议实施路线图

1. **已完成**: 数据解析 Isolate 化，Hive 本地存储基础架构，后台轮询降频。
2. **进行中**: 历史数据压缩与上传策略，离线模式集成。
3. **待开始**: 折线图组件深度重绘（MDUI3 适配与交互优化），网络层协议优化（HTTP/2 + Protobuf）。

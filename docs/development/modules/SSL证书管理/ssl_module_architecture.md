# SSL证书管理模块架构设计

## 模块目标

SSL证书管理模块旨在为用户提供便捷、安全的SSL证书管理能力，实现：
- 自动化证书申请与续期
- 多种证书类型支持
- 证书状态实时监控
- 网站HTTPS一键部署

## 功能完整性清单

### 基于OpenAPI端点

| 端点 | 方法 | 功能 | 实现状态 | UI状态 |
|------|------|------|---------|--------|
| `/websites/ssl` | POST | 创建证书 | ✅ 完成 | ❌ 待开发 |
| `/websites/ssl/{id}` | GET | 获取详情 | ✅ 完成 | ❌ 待开发 |
| `/websites/ssl/del` | POST | 删除证书 | ✅ 完成 | ❌ 待开发 |
| `/websites/ssl/download` | POST | 下载证书 | ✅ 完成 | ❌ 待开发 |
| `/websites/ssl/obtain` | POST | 申请证书 | ✅ 完成 | ❌ 待开发 |
| `/websites/ssl/resolve` | POST | 解析证书 | ✅ 完成 | ❌ 待开发 |
| `/websites/ssl/search` | POST | 搜索证书 | ✅ 完成 | ❌ 待开发 |
| `/websites/ssl/update` | POST | 更新证书 | ✅ 完成 | ❌ 待开发 |
| `/websites/ssl/upload` | POST | 上传证书 | ✅ 完成 | ❌ 待开发 |
| `/websites/ssl/website/{id}` | GET | 网站证书 | ✅ 完成 | ❌ 待开发 |
| `/websites/ssl/options` | GET | SSL选项 | ✅ 完成 | ❌ 待开发 |
| `/websites/ssl/validate` | POST | 验证配置 | ✅ 完成 | ❌ 待开发 |
| `/websites/ssl/auto-renew` | POST | 自动续期 | ✅ 完成 | ❌ 待开发 |

### 功能清单

| 功能模块 | 子功能 | 优先级 | 状态 |
|---------|--------|--------|------|
| **证书列表** | 列表展示 | P0 | API完成 |
| | 搜索过滤 | P0 | API完成 |
| | 状态筛选 | P0 | API完成 |
| | 批量操作 | P1 | 待开发 |
| **证书申请** | Let's Encrypt申请 | P0 | API完成 |
| | 自定义证书上传 | P0 | API完成 |
| | DNS验证 | P1 | API完成 |
| | HTTP验证 | P1 | API完成 |
| **证书详情** | 基本信息展示 | P0 | API完成 |
| | 域名列表 | P0 | API完成 |
| | 关联网站 | P0 | API完成 |
| **证书操作** | 更新证书 | P0 | API完成 |
| | 续期证书 | P0 | API完成 |
| | 下载证书 | P0 | API完成 |
| | 删除证书 | P0 | API完成 |

## 业务流程与交互验证

### 1. Let's Encrypt证书申请流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  点击申请   │────▶│ 选择域名    │────▶│ 选择验证方式│
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                    ┌──────────────────────────┴──────┐
                    │ DNS验证                        │ HTTP验证
                    ▼                                 ▼
           ┌─────────────┐                   ┌─────────────┐
           │ 配置DNS记录 │                   │ 部署验证文件│
           └──────┬──────┘                   └──────┬──────┘
                  │                                 │
                  └───────────────┬─────────────────┘
                                  ▼
                         ┌─────────────┐
                         │ 提交申请    │
                         └──────┬──────┘
                                │
                    ┌───────────┴───────────┐
                    │ 成功                  │ 失败
                    ▼                       ▼
             ┌─────────────┐         ┌─────────────┐
             │ 部署证书    │         │ 显示错误    │
             └─────────────┘         └─────────────┘
```

### 2. 证书续期流程

```
检测即将过期 ──▶ 发送提醒 ──▶ 用户确认续期
                                    │
                    ┌───────────────┴───────────────┐
                    │ 自动续期                      │ 手动续期
                    ▼                               ▼
           ┌─────────────┐                 ┌─────────────┐
           │ 自动申请    │                 │ 重新申请    │
           └──────┬──────┘                 └──────┬──────┘
                  │                               │
                  └───────────────┬───────────────┘
                                  ▼
                         ┌─────────────┐
                         │ 更新证书    │
                         └──────┬──────┘
                                │
                                ▼
                         ┌─────────────┐
                         │ 通知用户    │
                         └─────────────┘
```

### 3. 自定义证书上传流程

```
选择上传 ──▶ 填写域名 ──▶ 上传证书文件
                                │
                                ▼
                       ┌─────────────┐
                       │ 验证证书    │
                       └──────┬──────┘
                              │
                    ┌─────────┴─────────┐
                    │ 有效              │ 无效
                    ▼                   ▼
             ┌─────────────┐     ┌─────────────┐
             │ 保存证书    │     │ 显示错误    │
             └─────────────┘     └─────────────┘
```

## 关键边界与异常处理

### 边界条件

| 场景 | 边界值 | 处理方式 |
|------|--------|---------|
| 域名数量 | 1-100个 | 前端校验+后端校验 |
| 证书文件大小 | 最大10MB | 前端限制+后端校验 |
| 私钥长度 | 2048/4096位 | 前端提示+后端校验 |
| 证书有效期 | 最长398天 | 显示警告 |
| 续期提前时间 | 30天 | 自动提醒 |

### 异常处理

| 异常类型 | 错误码 | 处理策略 |
|---------|--------|---------|
| DNS验证失败 | 400 | 显示DNS配置指引 |
| HTTP验证失败 | 400 | 显示验证文件路径 |
| 证书格式错误 | 400 | 显示格式要求 |
| 域名验证失败 | 403 | 显示域名所有权验证 |
| ACME账户错误 | 401 | 引导重新配置账户 |
| 速率限制 | 429 | 显示限制信息和等待时间 |

## 模块分层与职责

### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    UI Layer (Pages)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │SSLListPage  │  │SSLDetailPage│  │SSLApplyPage │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│  ┌─────────────┐  ┌─────────────┐                      │
│  │SSLUploadDlg │  │DNSConfigDlg │                      │
│  └─────────────┘  └─────────────┘                      │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                 ViewModel Layer (Providers)              │
│  ┌─────────────────────────────────────────────────┐   │
│  │              SSLProvider                         │   │
│  │  - certificates, selectedCert, isLoading        │   │
│  │  - loadCertificates(), apply(), renew(), upload│   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  Service Layer                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │SSLService   │  │ACMEService  │  │DNSService   │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                   API Layer                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │              SSLV2Api                            │   │
│  │  - createWebsiteSSL, getWebsiteSSLById          │   │
│  │  - applySSL, uploadSSL, searchWebsiteSSL        │   │
│  │  - autoRenewSSL, downloadSSLFile, etc.          │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                 Data Layer                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │WebsiteSSL   │  │ACMEAccount  │  │DNSAccount   │     │
│  │SSLCertInfo  │  │SSLCertCreate│  │SSLCertUpdate│     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
```

### 职责划分

| 层级 | 组件 | 职责 |
|------|------|------|
| **UI层** | SSLListPage | 证书列表展示、搜索、批量操作 |
| | SSLDetailPage | 证书详情、关联网站、操作按钮 |
| | SSLApplyPage | Let's Encrypt申请表单 |
| | SSLUploadDialog | 自定义证书上传 |
| | DNSConfigDialog | DNS验证配置 |
| **ViewModel层** | SSLProvider | 证书状态管理、业务逻辑协调 |
| **Service层** | SSLService | 证书业务逻辑封装 |
| | ACMEService | ACME协议处理 |
| | DNSService | DNS验证处理 |
| **API层** | SSLV2Api | API调用封装 |
| **Data层** | 各类模型 | 数据结构定义与序列化 |

## 数据流设计

### 证书列表加载流程

```
页面进入 ──▶ SSLListPage.initState()
                    │
                    ▼
           SSLProvider.loadCertificates()
                    │
                    ▼
           SSLV2Api.searchWebsiteSSL(search)
                    │
                    ▼
           服务器响应 PageResult<WebsiteSSL>
                    │
                    ▼
           SSLProvider.updateCertificates()
                    │
                    ▼
           UI刷新展示列表
```

### 证书申请流程

```
用户提交申请 ──▶ SSLApplyPage.submit()
                    │
                    ▼
           SSLProvider.applyCertificate()
                    │
                    ▼
           SSLService.validateDomains()
                    │
                    ▼
           SSLV2Api.applySSL(apply)
                    │
                    ▼
           服务器处理申请
                    │
                    ▼
           轮询申请状态
                    │
                    ▼
           SSLProvider.updateStatus()
                    │
                    ▼
           UI显示申请结果
```

## 与现有实现的差距

### 已实现

| 组件 | 文件 | 状态 |
|------|------|------|
| API客户端 | lib/api/v2/ssl_v2.dart | ✅ 完成 |
| 数据模型 | lib/data/models/ssl_models.dart | ✅ 完成 |

### 待实现

| 组件 | 优先级 | 预计工作量 |
|------|--------|-----------|
| SSLProvider | P0 | 4小时 |
| SSLService | P0 | 3小时 |
| SSLListPage | P0 | 6小时 |
| SSLDetailPage | P0 | 4小时 |
| SSLApplyPage | P0 | 6小时 |
| SSLUploadDialog | P1 | 3小时 |
| DNSConfigDialog | P1 | 3小时 |
| 单元测试 | P0 | 4小时 |

## 评审记录表

| 日期 | 评审人 | 评审内容 | 结果 | 备注 |
|------|--------|---------|------|------|
| 2026-02-14 | - | 初始架构设计 | 待评审 | - |

---

**文档版本**: 1.0  
**最后更新**: 2026-02-14  
**维护者**: Open1Panel开发团队

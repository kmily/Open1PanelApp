# 模块适配专属工作流

本文档定义了模块适配的标准工作流程，确保每个模块的开发、测试和文档维护都有统一规范。

---

## 重要说明

### 模块适配目标

本文档所述的**模块适配**是指对 **1Panel V2 API** 的适配工作，API文档位于：
- `docs/1PanelOpenAPI/1PanelV2OpenAPI.json`

### 架构背景

```
┌─────────────────────────────────────────────────────────────┐
│                    Open1PanelApp (移动端)                    │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  App自身模块  │  │  1Panel管理模块 │  │   其他模块   │         │
│  │ (关于/设置等) │  │ (本工作流重点)  │  │ (后续优化)   │         │
│  └─────────────┘  └──────┬──────┘  └─────────────┘         │
│                          │                                  │
└──────────────────────────┼──────────────────────────────────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
              ▼            ▼            ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐
        │ 1Panel   │ │ 1Panel   │ │ 1Panel   │
        │ 服务器A   │ │ 服务器B   │ │ 服务器C   │
        │(用户添加) │ │(用户添加) │ │(用户添加) │
        └──────────┘ └──────────┘ └──────────┘
```

### 模块分类

| 模块类型 | 说明 | 是否使用1Panel API | 本工作流适用 |
|----------|------|-------------------|--------------|
| **1Panel管理模块** | 容器、网站、文件、应用、数据库等管理功能 | ✅ 是 | ✅ 适用 |
| **App自身模块** | 关于页面、App设置、主题切换等 | ❌ 否 | ❌ 不适用 |
| **混合模块** | 部分功能依赖1Panel API | 部分 | 部分适用 |

### 1Panel管理模块列表

以下模块均基于 `1PanelV2OpenAPI.json` 进行适配：

| 模块 | API关键词 | 功能描述 |
|------|-----------|----------|
| 仪表盘 | dashboard | 系统概览、资源监控 |
| 容器管理 | container | Docker容器操作 |
| 网站管理 | website | OpenResty网站配置 |
| 应用管理 | app | 应用商店、安装管理 |
| 数据库管理 | database | MySQL/PostgreSQL等 |
| 文件管理 | file | 服务器文件操作 |
| 监控管理 | monitor | 系统监控、告警 |
| 备份管理 | backup | 备份账户、备份任务 |
| SSL证书 | ssl | 证书申请、管理 |
| 防火墙 | firewall | 防火墙规则管理 |
| 计划任务 | cronjob | 定时任务管理 |
| SSH管理 | ssh | SSH配置、终端 |
| 运行时管理 | runtime | PHP/Node.js等运行时 |
| 进程管理 | process | 系统进程管理 |
| 日志管理 | log | 系统日志查看 |
| 主机管理 | host | 主机信息、终端 |
| 认证管理 | auth | 用户认证授权 |
| 设备管理 | device | 设备信息管理 |
| 工具箱 | toolbox | 系统工具集 |
| AI管理 | ai | AI模型管理 |
| 命令管理 | command | 快捷命令管理 |
| 系统分组 | group | 服务器分组管理 |
| 系统设置 | setting | 1Panel系统设置 |

### App自身模块说明

以下模块属于App自身功能，**不依赖1Panel API**，不在本工作流范围内：

| 模块 | 说明 | 处理方式 |
|------|------|----------|
| 关于页面 | App版本、开发者信息 | 按移动应用标准实现 |
| App设置 | 主题、语言、通知设置 | 使用本地存储 |
| 服务器管理 | 添加/编辑/删除服务器连接 | 本地数据管理 |
| 账户管理 | App账户登录/注册 | 独立后端服务 |
| 推送通知 | 消息推送设置 | 使用推送服务SDK |

> **注意**：App自身模块应根据业内最佳实践和移动应用标准进行开发，无需遵循本工作流的API适配流程。

---

## 目标平台

| 平台 | 状态 | 说明 |
|------|------|------|
| iOS | ✅ 支持 | iPhone 设备 |
| iPadOS | ✅ 支持 | iPad 设备 |
| Android | ✅ 支持 | Android 手机 |
| Android Tablet | ✅ 支持 | Android 平板 |

> 注：其他平台暂不在当前适配范围，但架构设计需预留扩展性。

---

## 一、API文档获取阶段

### 1.1 使用分析脚本获取API文档

由于 `1PanelV2OpenAPI.json` 文件过大（几万行），直接读取会导致上下文爆炸，必须使用专用脚本提取模块API信息。

**脚本位置**: `docs/development/modules/analyze_module_api.py`

**使用方法**:
```bash
cd docs/development/modules
python3 analyze_module_api.py <模块关键词> [输出目录]
```

**输出文件**:
- `{模块}_api_analysis.md` - Markdown格式API分析报告
- `{模块}_api_analysis.json` - JSON格式API数据

### 1.2 支持的模块关键词

| 关键词 | 输出目录 | 关键词 | 输出目录 |
|--------|----------|--------|----------|
| dashboard | 仪表盘 | ssh | SSH管理 |
| container | 容器管理 | firewall | 防火墙管理 |
| website | 网站管理-OpenResty | cronjob | 计划任务管理 |
| app | 应用管理 | ssl | SSL证书管理 |
| database | 数据库管理 | log | 日志管理 |
| file | 文件管理 | ai | AI管理 |
| setting | 系统设置 | host | 主机管理 |
| monitor | 监控管理 | command | 命令管理 |
| backup | 备份账户管理 | process | 进程管理 |
| runtime | 运行时管理 | auth | 认证管理 |
| device | 设备管理 | toolbox | 工具箱 |
| group | 系统分组 | | |

---

## 二、UI链路分析阶段

### 2.1 分析范围

针对目标模块进行完整的UI链路分析，包括：

| 分析维度 | 具体内容 |
|----------|----------|
| **组件结构** | 分析组件层级关系、复用性及职责划分，识别冗余组件和不合理依赖 |
| **状态管理** | 评估状态流转逻辑、数据共享机制及状态一致性，检查性能瓶颈 |
| **样式实现** | 检查样式组织方式、主题系统及响应式设计实现，评估复用性 |
| **性能表现** | 分析渲染效率、资源加载策略及交互响应速度 |
| **代码质量** | 评估代码规范遵循度、注释完整性及测试覆盖率 |

### 2.2 相关文件路径

| 类型 | 路径 |
|------|------|
| API客户端 | `lib/api/v2/{模块}_v2.dart` |
| 数据模型 | `lib/data/models/{模块}_models.dart` |
| 服务层 | `lib/features/{模块}/{模块}_service.dart` |
| 状态管理 | `lib/features/{模块}/{模块}_provider.dart` |
| UI页面 | `lib/features/{模块}/{模块}_page.dart` |
| 模块文档 | `docs/development/modules/{模块名}/` |

### 2.3 重复代码检查（必须执行）

**重要原则**: 创建任何文件/函数/方法/代码前，必须检查工作区内是否已存在类似实现。

**检查清单**:
- [ ] 检查是否已存在相同功能的 Provider
- [ ] 检查是否已存在相同功能的 Service
- [ ] 检查是否已存在相同功能的 Model
- [ ] 检查是否已存在相同功能的 UI 组件
- [ ] 检查是否已存在相同功能的工具类
- [ ] 检查存储架构文档 `docs/development/storage/` 是否有相关指导

### 2.4 分析结果处理

- 分析结果写入已有文档（非必要不新建文档）
- 更新模块索引文件 `{模块}_module_index.md`
- 记录发现的问题和待改进项

---

## 三、API测试验证阶段（必须执行）

### 3.1 测试环境配置

**配置文件**:
- `.env.example` - 配置模板（提交到版本控制）
- `.env` - 实际配置（不提交到版本控制，包含真实服务器信息）

**配置项**:
- `PANEL_BASE_URL` - 1Panel服务器地址
- `PANEL_API_KEY` - API密钥
- 其他配置参考 `.env.example`

### 3.2 测试文件位置

`test/api_client/` 目录下，命名规范: `{模块}_api_test.dart`

### 3.3 测试目的（必须完成）

1. **验证请求正确性**: 确保客户端请求体格式、端点路径、请求方法正确
2. **获取真实返回体**: 了解API实际返回的数据结构，避免依赖文档导致的偏差
3. **测试参数边界**: 验证必填参数、可选参数、边界条件
4. **记录返回体示例**: 用于后续开发参考

### 3.4 测试规范

**禁止事项**:
- ❌ 硬编码服务器IP地址
- ❌ 硬编码API密钥/Token
- ❌ 硬编码任何敏感信息
- ❌ 使用非国际化字符串（UI显示文本）

**必须事项**:
- ✅ 使用 `TestEnvironment.initialize()` 初始化测试环境
- ✅ 从环境变量读取配置
- ✅ 引用 `lib/api/v2/` 中的API客户端代码
- ✅ 打印完整的请求和响应数据用于分析

### 3.5 返回体验证要点

- [ ] 确认返回体结构与模型定义一致
- [ ] 确认必填字段不为空
- [ ] 确认数据类型正确
- [ ] 确认分页数据格式正确
- [ ] 记录实际返回体示例，用于后续开发参考

### 3.6 运行测试

```bash
flutter test test/api_client/{模块}_api_test.dart --no-pub
```

---

## 四、国际化处理阶段

### 4.1 国际化文件位置

| 文件 | 路径 |
|------|------|
| 英文 | `lib/l10n/app_en.arb` |
| 中文 | `lib/l10n/app_zh.arb` |

### 4.2 命名规范

- 格式: `{模块名}{类型}{描述}`
- 示例: `filesPageTitle`、`filesActionDelete`、`filesDeleteConfirm`

### 4.3 处理流程

1. 在 `app_en.arb` 中添加英文字符串
2. 在 `app_zh.arb` 中添加中文字符串
3. 执行 `flutter gen-l10n` 生成国际化代码

### 4.4 禁止事项

- ❌ UI代码中直接使用硬编码字符串
- ❌ 使用中文字符串作为代码逻辑判断条件
- ✅ 所有用户可见文本必须通过国际化系统获取

---

## 五、架构改造实施阶段

### 5.1 制定改造方案

基于评估结果制定详细的架构优化方案：
- 明确改造范围
- 确定优先级
- 规划技术路径

### 5.2 实施改造

- 确保所有功能模块迁移后正常运行
- 符合设计规范
- 每次修改后执行 `flutter build` 验证

### 5.3 设计规范

- UI框架统一采用 Material Design 3（MDUI3）规范
- 遵循项目现有代码风格和架构模式
- 保持与现有系统的兼容性
- 支持响应式布局（手机/平板适配）

### 5.4 平台适配要点

| 平台 | 适配要点 |
|------|----------|
| iOS | 遵循 Human Interface Guidelines，支持 Safe Area |
| iPadOS | 支持分屏、多任务，优化大屏布局 |
| Android | 遵循 Material Design，支持返回键手势 |
| Android Tablet | 优化大屏布局，支持横竖屏切换 |

---

## 六、验证与文档更新阶段

### 6.1 构建验证

每次修改后执行：
```bash
flutter build apk --debug
```

### 6.2 测试验证

```bash
flutter test test/api_client/{模块}_api_test.dart --no-pub
```

### 6.3 文档更新

更新以下文档（如适用）：
- `{模块}_module_index.md` - 模块索引
- `{模块}_module_architecture.md` - 架构设计
- `{模块}_plan.md` - 开发计划
- `{模块}_faq.md` - 常见问题

---

## 七、工作流检查清单

### 7.1 前置检查
- [ ] 1. 运行 `analyze_module_api.py` 获取API文档
- [ ] 2. 检查工作区内是否已存在类似实现（避免重复）
- [ ] 3. 检查存储架构文档 `docs/development/storage/`
- [ ] 4. 分析现有UI链路（组件、状态、样式、性能、代码质量）

### 7.2 API验证（必须完成）
- [ ] 5. 创建/更新 API测试文件（遵循测试环境配置）
- [ ] 6. 运行API测试验证请求和返回体
- [ ] 7. 记录真实返回体示例
- [ ] 8. 确认返回体结构与模型定义一致

### 7.3 实施改造
- [ ] 9. 添加国际化字符串（中英文）
- [ ] 10. 执行 `flutter gen-l10n` 生成国际化代码
- [ ] 11. 制定架构改造方案
- [ ] 12. 实施架构改造

### 7.4 验证完成
- [ ] 13. 执行 `flutter build` 验证
- [ ] 14. 更新模块文档

---

## 八、错误处理规范

### 8.1 错误分类

| 错误类型 | 说明 | 处理方式 |
|----------|------|----------|
| **网络错误** | 无网络连接、超时、服务器无响应 | 提示用户检查网络，提供重试选项 |
| **API错误** | 认证失败、权限不足、参数错误、服务器错误 | 显示具体错误信息，必要时引导用户操作 |
| **数据错误** | 数据解析错误、数据格式不匹配 | 记录日志，降级处理或显示友好提示 |
| **应用错误** | 状态错误、资源不足、未知错误 | 记录日志，尝试恢复或显示错误页面 |

### 8.2 错误处理模式

使用 `Result` 模式处理可能失败的操作：

```dart
Future<Result<User>> fetchUser(String userId) async {
  try {
    final response = await _apiService.get('/users/$userId');
    return Success(User.fromJson(response.data));
  } catch (e) {
    _logger.e('Failed to fetch user: $e');
    return Error('获取用户信息失败，请稍后重试');
  }
}
```

### 8.3 全局错误处理

在 `main.dart` 中设置全局错误处理：

```dart
void main() {
  FlutterError.onError = (details) {
    // 记录错误日志
    AppLogger.e('Flutter Error: ${details.exception}', stackTrace: details.stack);
  };
  
  runApp(const MyApp());
}
```

### 8.4 网络错误处理

统一处理 Dio 异常：

```dart
class ApiErrorHandler {
  static String handleError(DioException error) {
    switch (error.type) {
      case DioExceptionType.connectionTimeout:
        return '连接超时，请检查网络连接';
      case DioExceptionType.sendTimeout:
        return '发送超时，请重试';
      case DioExceptionType.receiveTimeout:
        return '接收超时，请重试';
      case DioExceptionType.badResponse:
        final statusCode = error.response?.statusCode;
        if (statusCode == 401) return '未授权，请重新登录';
        if (statusCode == 403) return '权限不足';
        if (statusCode == 404) return '资源不存在';
        if (statusCode! >= 500) return '服务器错误，请稍后重试';
        return '请求失败: ${error.response?.data['message']}';
      case DioExceptionType.cancel:
        return '请求已取消';
      default:
        return '网络错误，请检查网络连接';
    }
  }
}
```

### 8.5 Debug模式错误输出

在开发阶段，使用 `DebugErrorDialog` 在应用内直接显示错误信息：

```dart
try {
  await provider.loadData();
} catch (e) {
  DebugErrorDialog.show(context, error: e);
}
```

---

## 九、安全规范

### 9.1 敏感数据存储

| 数据类型 | 存储方式 | 说明 |
|----------|----------|------|
| 认证令牌 | `flutter_secure_storage` | 加密存储，自动过期机制 |
| API密钥 | 环境变量 `.env` | 不提交到版本控制 |
| 用户密码 | 禁止存储 | 仅传输，不持久化 |
| 服务器连接信息 | `flutter_secure_storage` | 加密存储 |

### 9.2 网络安全

- ✅ 所有API请求使用HTTPS
- ✅ 敏感数据额外加密
- ✅ 实现证书固定（Certificate Pinning）
- ✅ 请求签名防重放攻击

### 9.3 代码安全

- ❌ 禁止硬编码敏感信息（密钥、Token、服务器地址）
- ❌ 禁止在日志中输出敏感数据
- ✅ 使用环境变量管理配置
- ✅ 验证用户输入，防止注入攻击

### 9.4 权限控制

- 仅请求应用需要的最小权限
- 敏感操作需要二次确认
- 实现基于角色的访问控制（RBAC）

---

## 十、性能优化规范

### 10.1 渲染性能

| 优化项 | 实现方式 |
|--------|----------|
| 避免不必要的重建 | 使用 `const` 构造函数 |
| 长列表优化 | 使用 `ListView.builder` 懒加载 |
| 图片缓存 | 使用 `CachedNetworkImage` |
| 隔离重绘 | 使用 `RepaintBoundary` |

### 10.2 内存管理

- ✅ 在 `dispose` 方法中释放资源（定时器、监听器、订阅）
- ✅ 避免内存泄漏，正确管理订阅和引用
- ✅ 优化大对象，避免创建过大的对象

```dart
class _MyWidgetState extends State<MyWidget> {
  late StreamSubscription _subscription;
  
  @override
  void dispose() {
    _subscription.cancel(); // 释放资源
    super.dispose();
  }
}
```

### 10.3 网络性能

| 优化项 | 实现方式 |
|--------|----------|
| 请求缓存 | 使用 Dio 缓存拦截器 |
| 批量请求 | 合并多个小请求 |
| 数据压缩 | 启用 GZIP 压缩 |
| 超时控制 | 设置合理的超时时间（建议30秒） |

### 10.4 状态管理优化

使用 `Selector` 精确控制重建范围：

```dart
Selector<AuthProvider, bool>(
  selector: (context, authProvider) => authProvider.isLoggedIn,
  builder: (context, isLoggedIn, child) {
    return isLoggedIn ? const HomePage() : const LoginPage();
  },
)
```

---

## 十一、存储使用规范

### 11.1 核心原则

1. **统一接口**: 必须通过 `StorageService` 接口操作存储
2. **数据隔离**: 不同业务模块使用独立的 Box 或命名空间
3. **加密存储**: 敏感数据使用 AES-256 加密
4. **异步操作**: 所有存储操作必须是异步的
5. **版本控制**: 数据模型变更时进行版本迁移

### 11.2 命名规范

**Box 命名**: `module_data` 或 `module_feature_data`
- 示例: `monitor_data`, `auth_session`, `user_settings`

**Key 命名**: 分层命名法 `category_id_timestamp`
- 监控数据: `metric_yyyyMMddHH`
- 配置项: `setting_key`
- 缓存: `cache_url_hash`

### 11.3 数据迁移

当数据模型变更时：
1. 新字段设为 nullable，读取旧数据给予默认值
2. 在存储数据中包含 `version` 字段
3. 在 `init()` 方法中检查版本号执行迁移

### 11.4 清理机制

| 数据类型 | 保留期限 |
|----------|----------|
| 监控原始数据 | 24小时 |
| 降采样数据（1小时粒度） | 30天 |
| 降采样数据（1天粒度） | 90天 |

---

## 十二、代码审查规范

### 12.1 审查清单

- [ ] 代码是否实现了预期功能
- [ ] 代码是否清晰、简洁、易于理解
- [ ] 是否考虑了性能影响
- [ ] 是否存在安全风险
- [ ] 是否有足够的测试覆盖
- [ ] 是否有适当的文档和注释
- [ ] 是否符合项目编码规范

### 12.2 存储合规检查

- [ ] 是否使用了 `StorageService` 接口
- [ ] 敏感数据是否开启了加密选项
- [ ] 是否处理了存储异常（磁盘满、文件损坏）
- [ ] 数据模型是否包含版本号或兼容性处理
- [ ] 是否避免了在主线程进行大量数据操作
- [ ] 存储 Key 是否符合命名规范
- [ ] 是否实现了数据清理逻辑

---

## 十三、参考文档

| 文档 | 路径 | 说明 |
|------|------|------|
| 存储架构设计 | `docs/development/storage/storage_architecture_design.md` | 存储方案架构设计 |
| 存储基准测试 | `docs/development/storage/storage_benchmark_report.md` | 存储性能基准测试报告 |
| 存储选型报告 | `docs/development/storage/storage_selection_report.md` | 存储方案选型分析 |
| 存储使用指南 | `docs/development/storage/storage_usage_guidelines.md` | 存储使用规范指南 |
| 测试环境配置 | `.env.example` | 测试环境配置模板 |
| 实际测试配置 | `.env` | 实际测试配置（不提交） |
| 技术架构文档 | `docs/development/technical_architecture.md` | 整体技术架构设计 |
| 数据模型设计 | `docs/development/data_model_design.md` | 数据模型定义 |
| 代码规范 | `docs/development/coding_standards.md` | 编码规范和最佳实践 |
| 测试策略 | `docs/development/testing_strategy.md` | 测试方法和流程 |
| 开发指南 | `docs/development/development_guide.md` | 完整开发指南 |
| UI设计规范 | `docs/development/material_you_design_guide.md` | Material Design 3 规范 |

---

**文档版本**: 6.0
**最后更新**: 2026-02-16
**维护者**: Open1Panel开发团队

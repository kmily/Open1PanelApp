# 主机管理模块架构设计

## 模块目标

主机管理模块旨在为用户提供多服务器集中管理能力，实现：
- 多主机统一接入管理
- 实时监控与告警
- 资源使用可视化
- 跨服务器运维操作

## 功能完整性清单

### 基于OpenAPI端点

| 端点 | 方法 | 功能 | 实现状态 | UI状态 |
|------|------|------|---------|--------|
| `/core/hosts` | POST | 创建主机 | ✅ 完成 | ❌ 待开发 |
| `/core/hosts/del` | POST | 删除主机 | ✅ 完成 | ❌ 待开发 |
| `/core/hosts/{id}/update` | POST | 更新主机 | ✅ 完成 | ❌ 待开发 |
| `/core/hosts/search` | POST | 搜索主机 | ✅ 完成 | ❌ 待开发 |
| `/core/hosts/{id}` | GET | 主机详情 | ✅ 完成 | ❌ 待开发 |
| `/core/hosts/{id}/monitor` | POST | 监控数据 | ✅ 完成 | ❌ 待开发 |
| `/core/hosts/{id}/monitor/setting` | GET | 监控设置 | ✅ 完成 | ❌ 待开发 |
| `/core/hosts/{id}/monitor/setting` | POST | 更新设置 | ✅ 完成 | ❌ 待开发 |
| `/core/hosts/{id}/monitor/search` | POST | 搜索监控 | ✅ 完成 | ❌ 待开发 |

### 功能清单

| 功能模块 | 子功能 | 优先级 | 状态 |
|---------|--------|--------|------|
| **主机列表** | 列表展示 | P0 | API完成 |
| | 搜索过滤 | P0 | API完成 |
| | 状态显示 | P0 | API完成 |
| **主机详情** | 基本信息展示 | P0 | API完成 |
| | 监控图表 | P0 | API完成 |
| | 资源使用 | P0 | API完成 |
| **主机操作** | 添加主机 | P0 | API完成 |
| | 编辑主机 | P0 | API完成 |
| | 删除主机 | P0 | API完成 |
| **监控设置** | 阈值配置 | P1 | API完成 |
| | 告警规则 | P1 | API完成 |

## 业务流程与交互验证

### 1. 主机添加流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  点击添加   │────▶│ 填写信息    │────▶│ 验证连接    │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                    ┌──────────────────────────┴──────┐
                    │ 成功                            │ 失败
                    ▼                                 ▼
           ┌─────────────┐                   ┌─────────────┐
           │ 保存主机    │                   │ 显示错误    │
           └──────┬──────┘                   └─────────────┘
                  │
                  ▼
           ┌─────────────┐
           │ 刷新列表    │
           └─────────────┘
```

### 2. 监控数据查看流程

```
选择主机 ──▶ 进入详情 ──▶ 查看监控
                                │
                    ┌───────────┴───────────┐
                    │ 实时                   │ 历史
                    ▼                        ▼
           ┌─────────────┐          ┌─────────────┐
           │ 实时刷新    │          │ 选择时间    │
           └─────────────┘          └──────┬──────┘
                                            │
                                            ▼
                                    ┌─────────────┐
                                    │ 加载历史    │
                                    └─────────────┘
```

### 3. 告警配置流程

```
进入监控设置 ──▶ 配置阈值 ──▶ 设置告警规则
                                    │
                    ┌───────────────┴───────────────┐
                    │ CPU告警                       │ 内存告警
                    ▼                               ▼
           ┌─────────────┐                 ┌─────────────┐
           │ 设置CPU阈值 │                 │ 设置内存阈值│
           └─────────────┘                 └─────────────┘
```

## 关键边界与异常处理

### 边界条件

| 场景 | 边界值 | 处理方式 |
|------|--------|---------|
| 主机名称 | 1-64字符 | 前端校验+后端校验 |
| 主机地址 | 有效IP或域名 | 格式校验 |
| 监控周期 | 1s-300s | 前端限制 |
| 告警阈值 | 1-100% | 前端限制 |
| 主机数量 | 最大100台 | 分页展示 |

### 异常处理

| 异常类型 | 错误码 | 处理策略 |
|---------|--------|---------|
| 主机连接失败 | 503 | 显示错误，提供重试 |
| 认证失败 | 401 | 提示检查密钥配置 |
| 主机不存在 | 404 | 提示主机已删除 |
| 监控数据获取失败 | 500 | 显示离线状态 |
| 告警发送失败 | 502 | 记录日志，重试发送 |

## 模块分层与职责

### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    UI Layer (Pages)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │HostListPage │  │HostDetailPage│  │HostFormPage │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│  ┌─────────────┐  ┌─────────────┐                      │
│  │MonitorChart │  │AlertConfig  │                      │
│  └─────────────┘  └─────────────┘                      │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                 ViewModel Layer (Providers)              │
│  ┌─────────────────────────────────────────────────┐   │
│  │              HostProvider                        │   │
│  │  - hosts, selectedHost, monitorData             │   │
│  │  - loadHosts(), getMonitor(), updateSetting()   │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  Service Layer                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │HostService  │  │MonitorSvc   │  │AlertService │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                   API Layer                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │              HostV2Api                           │   │
│  │  - createHost, deleteHost, updateHost           │   │
│  │  - getHosts, getHostDetail, getHostMonitorData  │   │
│  │  - getHostMonitorSetting, updateHostMonitorSet  │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                 Data Layer                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │HostInfo     │  │HostMonitor  │  │HostMonitor  │     │
│  │HostCreate   │  │HostUpdate   │  │Setting      │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
```

### 职责划分

| 层级 | 组件 | 职责 |
|------|------|------|
| **UI层** | HostListPage | 主机列表展示、搜索、状态 |
| | HostDetailPage | 主机详情、监控图表 |
| | HostFormPage | 添加/编辑主机表单 |
| | MonitorChartWidget | 监控图表组件 |
| | AlertConfigDialog | 告警配置对话框 |
| **ViewModel层** | HostProvider | 主机状态管理、业务逻辑协调 |
| **Service层** | HostService | 主机业务逻辑封装 |
| | MonitorService | 监控数据处理 |
| | AlertService | 告警逻辑处理 |
| **API层** | HostV2Api | API调用封装 |
| **Data层** | 各类模型 | 数据结构定义与序列化 |

## 与现有实现的差距

### 已实现

| 组件 | 文件 | 状态 |
|------|------|------|
| API客户端 | lib/api/v2/host_v2.dart | ✅ 完成 |

### 待实现

| 组件 | 优先级 | 预计工作量 |
|------|--------|-----------|
| HostProvider | P0 | 4小时 |
| HostService | P0 | 3小时 |
| HostListPage | P0 | 6小时 |
| HostDetailPage | P0 | 6小时 |
| HostFormPage | P0 | 4小时 |
| MonitorChartWidget | P1 | 4小时 |
| AlertConfigDialog | P1 | 3小时 |
| 单元测试 | P0 | 4小时 |

## 评审记录表

| 日期 | 评审人 | 评审内容 | 结果 | 备注 |
|------|--------|---------|------|------|
| 2026-02-14 | - | 初始架构设计 | 待评审 | - |

---

**文档版本**: 1.0  
**最后更新**: 2026-02-14  
**维护者**: Open1Panel开发团队
